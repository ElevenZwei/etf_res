# 20250923 亏损调查  

这一天里面的 1810 实盘账号出现了远远大于预期的亏损。  
问题可能出在时间延迟，或者下单延迟，或者大额滑点上。  
我们需要把回测和实盘的所有价格进行比较之后做出检查。  

NOTE: 有一些插件显示兼容性的问题需要处理，mkdx 在生成格式化表格的时候会使用 tab 键而不是 space 来控制大缩进，这个在 preview 渲染的时候会导致对齐问题。  
mkdx 需要一些额外的设置解决这个问题。  
然后是我自己的 markdown 回车加上空格的代码，如果这一行的最后一个字符是 | 的话，那么不应该添加空格。

## 回测情况  

### ETF  
这一天的 Roll Merged 仓位信号如下。

| roll_args_id | top |            dt             | position |
|--------------|-----|---------------------------|----------|
|      1       | 10  | 2025-09-23 01:35:00+00:00 |   1.0    |
|      1       | 10  | 2025-09-23 02:06:00+00:00 |   0.9    |
|      1       | 10  | 2025-09-23 02:24:00+00:00 |   0.6    |
|      1       | 10  | 2025-09-23 03:24:00+00:00 |   0.0    |
|      1       | 10  | 2025-09-23 05:00:00+00:00 |   -0.1   |
|      1       | 10  | 2025-09-23 06:54:00+00:00 |   0.5    |
|      1       | 10  | 2025-09-23 06:55:00+00:00 |   0.0    |


根据 cpr.roll_merged 表格，这天的 spot 收益是 -1.48% .  

|    date    |         daily         |     accumulated     |
|------------|-----------------------|---------------------|
| 2025-09-22 | 0.00186315101329265636  | 0.456304431771360539584000 |
| 2025-09-23 | -0.01489627498485766202 | 0.441408156786502877564000 |
| 2025-09-24 | 0.01899326045596723743  | 0.460401417242470114994000 |
| 2025-09-25 | 0.01466683525097989632  | 0.475068252493450011314000 |
| 2025-09-26 | 0.01162056334470127574 | 0.486688815838151287054000 |


### Nautilus 期权回测  
我们把这一天的信号输入 Nautilus 看看当日的期权交易情况。  




## 实盘情况  
实盘情况分成很多层面。  
从收盘净值上面看亏损了 11% ，这个数字远远大于回测的 1.4% 的倍率。  
因为我们看之后几天的倍率 09-24 1.8% -> 5%, 09-26 1.1% -> 4%, 09-29 1.4% -> 5.5% 。  
理论上的倍率应该控制在一个稳定的区间里面，按我们现在保证金的占用大概是 4 倍左右。


|   date   | net_worth |
|----------|-----------|
| 20250922 |   99111   |
| 20250923 |   88453  |
| 20250924 |  93612   |
| 20250926 |   97828  |
| 20250929 | 103378   |



### cpr 信号生成的时间  
cpr python 脚本后来运行的信号生成理想时间是这样。  
但是生成这些信号的时间应该晚了 30 秒。  

| roll_args_id | top |            dt             |          dt_raw           | open_count | position |
|--------------|-----|---------------------------|---------------------------|------------|----------|
|      1       | 10  | 2025-09-23 09:35:00+08:00 | 2025-09-23 09:35:01+08:00 |    10.0    |   1.0    |
|      1       | 10  | 2025-09-23 10:06:00+08:00 | 2025-09-23 10:06:00+08:00 |    9.0     |   0.9    |
|      1       | 10  | 2025-09-23 10:24:00+08:00 | 2025-09-23 10:24:01+08:00 |    6.0     |   0.6    |
|      1       | 10  | 2025-09-23 11:24:00+08:00 | 2025-09-23 11:24:01+08:00 |    0.0     |   0.0    |
|      1       | 10  | 2025-09-23 13:00:00+08:00 | 2025-09-23 13:00:01+08:00 |    1.0     |   -0.1   |
|      1       | 10  | 2025-09-23 14:51:00+08:00 | 2025-09-23 14:51:01+08:00 |    0.0     |   0.0    |



### spirit 信号生成的时间  
我们看到这里都是在 30 秒靠后的时候生成信号，说明 cpr python 脚本写入信号的时间应该是 30 秒。  


|   code   | position    | updated_at |
|----------|---------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------|
| 90005453 | {"code": "90006226", "amount": -14, "contract": "159915P2509M003100"}, {"code": "90006225", "amount": 14, "contract": "159915C2509M003100"} | 2025-09-23 09:36:32.081739+08 |
| 90005453 | {"code": "90006226", "amount": -12, "contract": "159915P2509M003100"}, {"code": "90006225", "amount": 12, "contract": "159915C2509M003100"} | 2025-09-23 10:06:34.957029+08 |
| 90005453 |  {"code": "90006226", "amount": -8, "contract": "159915P2509M003100"}, {"code": "90006225", "amount": 8, "contract": "159915C2509M003100"}  | 2025-09-23 10:24:34.488542+08 |
| 90005453 | empty | 2025-09-23 11:24:34.276317+08 |
| 90005453 |  {"code": "90006198", "amount": 1, "contract": "159915P2509M003000"}, {"code": "90006197", "amount": -1, "contract": "159915C2509M003000"}  | 2025-09-23 13:00:34.144114+08 |
| 90005453 | empty | 2025-09-23 14:46:07.338407+08 |


### 下单交易的时间  
这一天的实际交易情况经过总结之后是这样的。  


|        time_from         |         time_to          | contract |        inst        | dir  | offset | amount | price  |
|--------------------------|--------------------------|----------|--------------------|------|--------|--------|--------|
| 20250923 01:36:31.235282 | 20250923 01:37:25.160993 | 90006226 | 159915P2509M003100 | SELL |  OPEN  |   14   | 0.0226 |
| 20250923 01:36:31.273252 | 20250923 01:37:25.161080 | 90006225 | 159915C2509M003100 | BUY  |  OPEN  |   14   | 0.0477 |
| 20250923 02:06:34.125117 | 20250923 02:06:34.125117 | 90006226 | 159915P2509M003100 | BUY  | CLOSE  |   2    | 0.0322 |
| 20250923 02:06:34.125175 | 20250923 02:06:34.125175 | 90006225 | 159915C2509M003100 | SELL | CLOSE  |   2    | 0.0346 |
| 20250923 02:24:34.155449 | 20250923 02:24:43.173827 | 90006226 | 159915P2509M003100 | BUY  | CLOSE  |   4    | 0.0485 |
| 20250923 02:24:34.155512 | 20250923 02:24:43.173901 | 90006225 | 159915C2509M003100 | SELL | CLOSE  |   4    | 0.0224 |
| 20250923 03:24:34.071715 | 20250923 03:25:01.111198 | 90006226 | 159915P2509M003100 | BUY  | CLOSE  |   8    |  0.08  |
| 20250923 03:24:34.106818 | 20250923 03:25:01.111272 | 90006225 | 159915C2509M003100 | SELL | CLOSE  |   8    | 0.0112 |
| 20250923 05:01:01.897202 | 20250923 05:01:01.897202 | 90006197 | 159915C2509M003000 | SELL |  OPEN  |   1    | 0.0479 |
| 20250923 05:02:25.072038 | 20250923 05:02:25.072038 | 90006198 | 159915P2509M003000 | BUY  |  OPEN  |   1    | 0.0248 |
| 20250923 06:46:07.170993 | 20250923 06:46:07.170993 | 90006198 | 159915P2509M003000 | SELL | CLOSE  |   1    | 0.0051 |
| 20250923 06:46:07.171052 | 20250923 06:46:07.171052 | 90006197 | 159915C2509M003000 | BUY  | CLOSE  |   1    | 0.0889 |

其中比较奇特的一点是 13:01 的下单在两个合约上面相差了整整一分钟。  
看日志的调查结果是这个合约的下单在不停地 timeout retry 里面用了一分钟。
159915P2509M003000  
这段时间里还出现了撤单失败，应该是这个时候合约处在冻结竞价的时候，我们在它的熔断过程里面下的单。  
不过最后的成交价格比我们一开始的报价更友好，我们的报价是 0.026 买入，最后成交的价格是 0.0248 。
关于熔断下单这个问题还没有好好解决过。  



